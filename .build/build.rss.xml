<?xml version="1.0" ?>

<!--
	PHING build file for releasing the 'changelog' notes of a package.

	@author Jean-Lou Dupont
	@version $Id: build.xml 253 2007-11-15 19:30:42Z JeanLou.Dupont $
-->
<project name="PackageReleaseRss" basedir="." default='rss'>

	<taskdef classname='JLD.PhingTools.SvnAddTask' name='svn_add' />
	<taskdef classname='JLD.PhingTools.SvnPropsetTask' name='svn_propset' />
	<taskdef classname='JLD.PhingTools.SvnStatusTask' name='svn_status' />

	<!--
		The package is located 1 level 'down' from the original build file.
	-->
	<target name='Config'>
		<resolvepath propertyName="project.path" file="${project.basedir}/../" /> <!-- 1 level down -->
		<property name='package.file' value='${project.path}/package.xml' />
		<echo>Package path: ${project.path}</echo>
	</target>

	<!-- 
		It is imperative that this task should run first;
		this task searches the 'root' of the channel in the filesystem.
	-->
	<target name='FindChannelRoot' depends='Config'>
		<taskdef classname='JLD.PearTools.phing.ChannelFindTask' name='channelfind' />
		<channelfind RootPath='channel.root' StartPath='${project.basedir}' />
		<echo>Channel root path: ${channel.root}</echo>
	</target>
	<!--
		This task initializes the base variables for the PEAR channel.
	-->
	<target name='InitChannel' depends='FindChannelRoot'>
		<taskdef classname='JLD.PearTools.phing.ChannelTask' name='channel' />
		<echo>Initializing Channel</echo>
		<channel path="${channel.root}" />
		<echo>Channel name:      "${channel.name}"</echo>
		<echo>Channel alias:     "${channel.alias}"</echo>
		<echo>Channel TAGS path: "${channel.tags}"</echo>
		<echo>Channel REST path: "${channel.rest}"</echo>
	</target>

	<!--
		Package level initialization:
	-->
	<target name='ReadPackageXML' depends='InitChannel'>
		<!-- T12 -->
		<!--<property file="./build.properties" />-->
		<taskdef classname='JLD.PearTools.phing.PackageReadTask' name='packageread' />
		<!-- T11 -->
		<packageread	propertyPackageFile="${package.file}"
						propertyPackageName='package.name' 
						propertyPackageNameL='package.namel' 
						propertyPackageVersion='package.version' 
						propertyPackageStability='package.stability' 
						propertyPackageSummary='package.summary' 
						propertyPackageDescription='package.description'
						propertyPackageDeps='package.dependencies'
						propertyPackageChangelog='package.changelog' />
		<echo>Package name:        ${package.name}</echo>
		<echo>Package category:    ${package.category}</echo>
		<echo>Package version:     ${package.version}</echo>
		<echo>Package stability:   ${package.stability}</echo>
		<echo>Package summary:     ${package.summary}</echo>
		<echo>Package description: ${package.description}</echo>
		<echo>Package changelog:   ${package.changelog}</echo>
	</target>

	<target name='rss' depends='ReadPackageXML'>

		<taskdef classname='JLD.PhingTools.DateTask' name='date' />
		<date propertyname="rss.date" />

		<!-- just in case -->
		<mkdir dir='${channel.root}/rss' />

		<echo>
			>>Creating RSS file
			>>===========================
		</echo>

		<echo file='${channel.root}/rss/${package.name}-${package.version}.xml'><![CDATA[<?xml version="1.0"?>
<rss version="2.0">
	<!-- This file was generated by Jean-Lou Dupont's PHING task for PEAR Channel -->
	<channel>
		<title>${rss.title}</title>
		<link>${rss.link}</link>
		<description>${rss.description}</description>
		<item>
			<title>${package.name} - ${package.version}</title>
			<link>http://php-aop.googlecode.com/</link>
			<description>Changelog:
${package.changelog}
			</description>
			<pubDate>${rss.date}</pubDate>
		</item>
	</channel>
</rss>]]></echo>

		<svn_status path='"${channel.root}/rss/${package.name}-${package.version}.xml"' 
					result="rss.exists" />
		<if>
			<contains substring="?" string="${rss.exists}" />
			<then>
				<echo>Adding RSS entry to SVN</echo>
				<svn_add path='"${channel.root}/rss/${package.name}-${package.version}.xml"' />
				<svn_propset path='"${channel.root}/rss/${package.name}-${package.version}.xml"' 
				           	propname="svn:mime-type" 
				           	propval="application/xml" />
			</then>
			<else>
				<echo>RSS entry already in SVN</echo>
			</else>
		</if>


	</target>

</project>